<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Link Joint (Firebase) — Demo</title>
  <style>
    body { font-family: system-ui,Segoe UI,Roboto,Arial; margin: 0; padding: 20px; background:#f6f8fa; color:#111; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:18px; }
    .card { background:#fff; border-radius:10px; padding:16px; box-shadow: 0 6px 18px rgba(10,10,10,0.06); margin-bottom:16px;}
    input, select, button, textarea { font:inherit; padding:8px; border-radius:6px; border:1px solid #dcdcdc; }
    label { display:block; margin-top:8px; font-weight:600; }
    .row { display:flex; gap:8px; align-items:center; }
    .small { font-size:0.9rem; color:#555; }
    .links { display:grid; gap:8px; }
    .link-row { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border-radius:8px; border:1px solid #eee; }
    .btn { cursor:pointer; background:#0366d6; color:white; padding:8px 12px; border-radius:8px; border:none; }
    .btn.ghost { background:transparent; color:#0366d6; border:1px solid #0366d6; }
    .danger { background:#e55353; }
    .muted { color:#666; font-size:0.9rem; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #eee; }
    .actions { display:flex; gap:6px; }
    .hidden { display:none; }
    footer { margin-top:20px; font-size:0.85rem; color:#666; }
    pre { background:#0b1220; color:#cfe; padding:12px; border-radius:8px; overflow:auto; font-size:0.85rem; }
  </style>
</head>
<body>
  <header>
    <h1>Link Joint</h1>
    <div id="auth-area" class="card" style="min-width:300px;">
      <div id="signed-out-ui">
        <div><strong>Sign in / Sign up</strong></div>
        <div class="small">Enter a username (like <code>eeeee24</code>) and password. The app will convert it to an email: <code>username@website.com</code>.</div>

        <label>Username</label>
        <input id="username" placeholder="username (no @)" autocomplete="username" />

        <label>Password</label>
        <input id="password" type="password" placeholder="password" autocomplete="current-password" />

        <div style="margin-top:8px;" class="row">
          <button id="btn-signup" class="btn">Create account</button>
          <button id="btn-signin" class="btn ghost">Sign in</button>
        </div>
        <div id="auth-msg" class="muted" style="margin-top:8px;"></div>
      </div>

      <div id="signed-in-ui" class="hidden">
        <div><strong id="user-display">Signed in</strong></div>
        <div class="small" id="user-role-display"></div>
        <div style="margin-top:8px;" class="row">
          <button id="btn-logout" class="btn ghost">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main app -->
  <main>
    <section id="admin-panel" class="card hidden">
      <h2>Admin: Manage Users</h2>
      <div class="small">Admins can view all users and change role/permission_lvl.</div>
      <div id="users-table-wrap"></div>
    </section>

    <section id="links-panel" class="card hidden">
      <h2>Links</h2>
      <div id="permission-hint" class="small muted" style="margin-bottom:8px;"></div>

      <div id="create-link-form" class="hidden" style="margin-bottom:12px;">
        <label>Title</label>
        <input id="link-title" placeholder="Link title" />
        <label>URL</label>
        <input id="link-url" placeholder="https://example.com" />
        <div style="margin-top:8px;" class="row">
          <button id="btn-create-link" class="btn">Create link</button>
        </div>
      </div>

      <div id="links-list" class="links"></div>
    </section>
  </main>

  <footer>
    <div class="small">This demo enforces permissions client-side. You should add server-side Firestore security rules before production.</div>
  </footer>

  <script type="module">
    // ---- Firebase setup (using modular SDK) ----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      collection,
      addDoc,
      query,
      onSnapshot,
      orderBy,
      where,
      getDocs,
      deleteDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // <-- your firebase config -->
    const firebaseConfig = {
      apiKey: "AIzaSyBHNeca9gURUczisK4gNV6LhBfzK65vg9U",
      authDomain: "link-joint.firebaseapp.com",
      projectId: "link-joint",
      storageBucket: "link-joint.firebasestorage.app",
      messagingSenderId: "568319687772",
      appId: "1:568319687772:web:0f04ad3a1d2597da63ba99",
      measurementId: "G-W88WBHPEDZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---- DOM refs ----
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const btnSignup = document.getElementById('btn-signup');
    const btnSignin = document.getElementById('btn-signin');
    const btnLogout = document.getElementById('btn-logout');
    const authMsg = document.getElementById('auth-msg');

    const signedOutUI = document.getElementById('signed-out-ui');
    const signedInUI = document.getElementById('signed-in-ui');
    const userDisplay = document.getElementById('user-display');
    const userRoleDisplay = document.getElementById('user-role-display');

    const adminPanel = document.getElementById('admin-panel');
    const usersTableWrap = document.getElementById('users-table-wrap');

    const linksPanel = document.getElementById('links-panel');
    const createLinkForm = document.getElementById('create-link-form');
    const linkTitleInput = document.getElementById('link-title');
    const linkUrlInput = document.getElementById('link-url');
    const btnCreateLink = document.getElementById('btn-create-link');
    const linksList = document.getElementById('links-list');
    const permissionHint = document.getElementById('permission-hint');

    // ---- Helpers ----
    function usernameToEmail(u) {
      // sanitize simple whitespace
      return (u.trim() + "@website.com").toLowerCase();
    }

    function showMsg(msg, isError = false) {
      authMsg.textContent = msg;
      authMsg.style.color = isError ? '#b00020' : '#666';
      setTimeout(() => { if (authMsg.textContent === msg) authMsg.textContent = ''; }, 5000);
    }

    // ---- Create account ----
    btnSignup.addEventListener('click', async () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      if (!username || !password) { showMsg('Provide username and password', true); return; }
      const email = usernameToEmail(username);
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCred.user;
        // create a user_data doc for the user. default role -> unapproved, permission_lvl -> 0
        await setDoc(doc(db, 'user_data', user.uid), {
          role: 'unapproved',
          permission_lvl: 0,
          displayName: username,
          createdAt: serverTimestamp()
        });
        showMsg('Account created. Waiting for admin approval (role=unapproved).');
        // automatically signed in after createUserWithEmailAndPassword
      } catch (err) {
        console.error(err);
        showMsg('Signup error: ' + err.message, true);
      }
    });

    // ---- Sign in ----
    btnSignin.addEventListener('click', async () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      if (!username || !password) { showMsg('Provide username and password', true); return; }
      const email = usernameToEmail(username);
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMsg('Signed in');
      } catch (err) {
        console.error(err);
        showMsg('Sign-in error: ' + err.message, true);
      }
    });

    // ---- Sign out ----
    btnLogout.addEventListener('click', async () => {
      await signOut(auth);
      showMsg('Signed out');
    });

    // ---- Realtime auth state listener ----
    let currentUserData = null;
    let linksUnsub = null;
    let usersUnsub = null;

    onAuthStateChanged(auth, async (user) => {
      // cleanup listeners
      if (linksUnsub) { linksUnsub(); linksUnsub = null; }
      if (usersUnsub) { usersUnsub(); usersUnsub = null; }

      if (user) {
        signedOutUI.classList.add('hidden');
        signedInUI.classList.remove('hidden');
        userDisplay.textContent = `Signed in: ${user.email} (uid: ${user.uid})`;

        // fetch the user's user_data doc
        const udRef = doc(db, 'user_data', user.uid);
        const udSnap = await getDoc(udRef);
        if (!udSnap.exists()) {
          // create default doc if missing
          await setDoc(udRef, { role: 'unapproved', permission_lvl: 0, createdAt: serverTimestamp() });
          currentUserData = { role: 'unapproved', permission_lvl: 0 };
        } else {
          currentUserData = udSnap.data();
        }

        userRoleDisplay.textContent = `role: ${currentUserData.role} — permission_lvl: ${currentUserData.permission_lvl}`;
        renderUIForPermissions(user, currentUserData);

        // If admin, subscribe to all users collection for live updates
        if (currentUserData.role === 'admin') {
          subscribeToAllUsers();
        }
      } else {
        // signed out
        signedOutUI.classList.remove('hidden');
        signedInUI.classList.add('hidden');
        userDisplay.textContent = 'Signed out';
        userRoleDisplay.textContent = '';
        linksPanel.classList.add('hidden');
        adminPanel.classList.add('hidden');
      }
    });

    // ---- Subscribe to links collection (real-time) ----
    function subscribeToLinks(user, userData) {
      // show links if permission_lvl >= 1
      if (!userData || userData.permission_lvl < 1) {
        linksPanel.classList.add('hidden');
        permissionHint.textContent = 'You do not have permission to view links.';
        return;
      }
      linksPanel.classList.remove('hidden');
      permissionHint.textContent = '';

      // For listing, admins and higher see all links; normal users see all links (spec didn't say to restrict by role),
      // but we will show all links to those with view permission.
      const q = query(collection(db, 'links'), orderBy('createdAt', 'desc'));

      linksUnsub = onSnapshot(q, (snapshot) => {
        linksList.innerHTML = '';
        if (snapshot.empty) {
          linksList.innerHTML = '<div class="muted">No links yet.</div>';
          return;
        }
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          const title = data.title || '(no title)';
          const url = data.url || '#';
          const creator = data.creator || '';
          const createdAt = data.createdAt ? new Date(data.createdAt.seconds*1000).toLocaleString() : '';

          const row = document.createElement('div');
          row.className = 'link-row';
          row.innerHTML = `
            <div style="flex:1">
              <div><a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(title)}</a></div>
              <div class="small muted">created by: ${creator} ${createdAt ? ' · ' + createdAt : ''}</div>
            </div>
            <div class="actions"></div>
          `;
          const actions = row.querySelector('.actions');

          // Viewers (level >=1) can see links (already enforced)
          // Create allowed on separate UI
          // Delete rules:
          // - permission_lvl 3: can delete any link
          // - permission_lvl 2: can delete only links they created
          // Edit rules:
          // - permission_lvl 3: can edit any link
          // (Assumption described earlier)
          const pl = userData.permission_lvl || 0;
          const isCreator = (user.uid === creator);

          if (pl >= 3) {
            const btnEdit = document.createElement('button'); btnEdit.className = 'btn ghost'; btnEdit.textContent = 'Edit';
            btnEdit.addEventListener('click', () => openEditDialog(id, data));
            actions.appendChild(btnEdit);
          }

          if ((pl >= 3) || (pl >= 2 && isCreator)) {
            const btnDelete = document.createElement('button'); btnDelete.className = 'btn danger'; btnDelete.textContent = 'Delete';
            btnDelete.addEventListener('click', async () => {
              if (!confirm('Delete this link?')) return;
              try {
                await deleteDoc(doc(db, 'links', id));
                showMsg('Link deleted');
              } catch (err) {
                console.error(err);
                showMsg('Delete error: ' + err.message, true);
              }
            });
            actions.appendChild(btnDelete);
          }

          linksList.appendChild(row);
        });
      }, (err) => {
        console.error(err);
        showMsg('Links listener error: ' + err.message, true);
      });
    }

    // ---- Create link ----
    btnCreateLink.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) { showMsg('Not signed in', true); return; }
      const ud = currentUserData || {};
      if (ud.permission_lvl < 2) { showMsg('Insufficient permission to create links', true); return; }
      const title = linkTitleInput.value.trim();
      const url = linkUrlInput.value.trim();
      if (!title || !url) { showMsg('Provide title and url', true); return; }
      try {
        await addDoc(collection(db, 'links'), {
          title,
          url,
          creator: user.uid,
          createdAt: serverTimestamp()
        });
        linkTitleInput.value = '';
        linkUrlInput.value = '';
        showMsg('Link created');
      } catch (err) {
        console.error(err);
        showMsg('Create link error: ' + err.message, true);
      }
    });

    // ---- Edit dialog (simple prompt-based) ----
    async function openEditDialog(linkId, data) {
      const user = auth.currentUser;
      const ud = currentUserData || {};
      if (!user) return;
      if (ud.permission_lvl < 3) { showMsg('Insufficient permission to edit links', true); return; }
      const newTitle = prompt('Edit title', data.title || '');
      if (newTitle === null) return;
      const newUrl = prompt('Edit URL', data.url || '');
      if (newUrl === null) return;
      try {
        await updateDoc(doc(db, 'links', linkId), { title: newTitle, url: newUrl });
        showMsg('Link updated');
      } catch (err) {
        console.error(err);
        showMsg('Update error: ' + err.message, true);
      }
    }

    // ---- Admin: subscribe & manage users ----
    function subscribeToAllUsers() {
      // show the admin panel
      adminPanel.classList.remove('hidden');
      // We'll pull snapshot of all docs in user_data
      const q = query(collection(db, 'user_data'), orderBy('createdAt', 'desc'));
      usersUnsub = onSnapshot(q, (snapshot) => {
        renderUsersTable(snapshot.docs);
      }, (err) => {
        console.error(err);
        showMsg('Users listener error: ' + err.message, true);
      });
    }

    function renderUsersTable(userDocs) {
      if (!userDocs || userDocs.length === 0) {
        usersTableWrap.innerHTML = '<div class="muted">No users found.</div>';
        return;
      }
      let html = '<table><thead><tr><th>UID</th><th>Display name</th><th>Role</th><th>Permission lvl</th><th>Actions</th></tr></thead><tbody>';
      for (const udoc of userDocs) {
        const ud = udoc.data();
        const uid = udoc.id;
        const display = ud.displayName || '';
        html += `<tr data-uid="${uid}">
          <td style="max-width:220px; word-break:break-all">${uid}</td>
          <td>${escapeHtml(display)}</td>
          <td>
            <select class="role-select" data-uid="${uid}">
              <option ${ud.role==='unapproved' ? 'selected' : ''} value="unapproved">unapproved</option>
              <option ${ud.role==='user' ? 'selected' : ''} value="user">user</option>
              <option ${ud.role==='admin' ? 'selected' : ''} value="admin">admin</option>
              <option ${ud.role==='owner' ? 'selected' : ''} value="owner">owner</option>
            </select>
          </td>
          <td><input type="number" class="perm-input" data-uid="${uid}" min="0" max="3" value="${ud.permission_lvl||0}" style="width:72px" /></td>
          <td><button class="update-user btn ghost" data-uid="${uid}">Update</button></td>
        </tr>`;
      }
      html += '</tbody></table>';
      usersTableWrap.innerHTML = html;

      // attach listeners to update buttons
      const updateBtns = usersTableWrap.querySelectorAll('.update-user');
      updateBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const uid = btn.dataset.uid;
          const sel = usersTableWrap.querySelector(`.role-select[data-uid="${uid}"]`);
          const permInput = usersTableWrap.querySelector(`.perm-input[data-uid="${uid}"]`);
          const newRole = sel.value;
          const newPerm = parseInt(permInput.value, 10) || 0;
          try {
            await updateDoc(doc(db, 'user_data', uid), { role: newRole, permission_lvl: newPerm });
            showMsg('User updated');
          } catch (err) {
            console.error(err);
            showMsg('Update user error: ' + err.message, true);
          }
        });
      });
    }

    // ---- Render UI depending on permission level ----
    function renderUIForPermissions(user, userData) {
      // admin panel visibility is handled elsewhere
      // Links visibility & create form:
      if (userData.permission_lvl >= 1) {
        linksPanel.classList.remove('hidden');
        permissionHint.textContent = '';
      } else {
        linksPanel.classList.add('hidden');
        permissionHint.textContent = 'You do not have permission to view links.';
      }

      if (userData.permission_lvl >= 2) {
        createLinkForm.classList.remove('hidden');
      } else {
        createLinkForm.classList.add('hidden');
      }

      // Subscribe to links if permission >=1
      if (userData.permission_lvl >= 1) {
        subscribeToLinks(user, userData);
      }

      // Admin UI handled in onAuthStateChanged (subscribeToAllUsers)
      if (userData.role === 'admin') {
        adminPanel.classList.remove('hidden');
      } else {
        adminPanel.classList.add('hidden');
      }
    }

    // ---- Utility: escape to avoid simple injection in element innerHTML ----
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ---- Notes & guidance for production (displayed to console) ----
    console.log(`Link Joint demo loaded.
- Collection 'user_data' must contain documents named by UID with fields: role (string), permission_lvl (number).
- Collection 'links' contains documents with title, url, creator (uid), createdAt (timestamp).
Important: This client enforces permissions only in the UI. Add Firestore security rules to secure your data in production.
`);

  </script>
</body>
</html>
